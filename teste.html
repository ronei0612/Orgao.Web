<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Botões de Play e Stop</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        #savesSelect option:not(:first-child) {
            color: black;
        }

        #savesSelect {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        #searchInput {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        #searchButton {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        #deleteSavesSelect {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .modal-textarea {
            width: 100%;
            height: 300px;
            resize: vertical;
            padding: 10px;
        }

        body {
            background-color: #F0F0F0;
            transition: background-color 0.3s;
        }

        body.dark-mode {
            background-color: #0C101C;
            color: #fff;
        }

        /* .dark-mode, */
        .modal-content {
            transition: background-color 0.3s, color 0.3s;
        }

        .modal-content {
            background-color: #F0F0F0;
            color: #333;
        }

        body.dark-mode .modal-content {
            background-color: #1D2439;
            color: white;
        }

        #toggleDarkMode {
            display: flex;
            align-items: center;
        }

        #toggleDarkMode i {
            margin-right: 8px;
        }

        .btn-custom {
            border-radius: 50%;
            color: white;
            width: 55px;
            height: 55px;
            font-size: 24px;
            border: none;
            transition: background-color .3s, box-shadow .3s;
            outline: 0;
            user-select: none;
            margin: 8px;
        }

        .btn-custom[data-action="play"] {
            background-color: #9988B4;
        }

        .btn-custom[data-action="play"].pressed {
            background-color: #8A2BE2;
            box-shadow: 0 0 10px #8A2BE2;
        }

        .btn-custom[data-action="play"].pulse {
            box-shadow: 0 0 20px 5px rgba(138, 43, 226, .7);
        }

        .btn-custom[data-action="notes"] {
            background-color: #9988B4;
        }

        .btn-custom[data-action="notes"].pressed {
            background-color: #8A2BE2;
            box-shadow: 0 0 10px #8A2BE2;
        }

        .btn-custom[data-action="stop"] {
            background-color: tomato;
        }

        .btn-custom[data-action="stop"].pressed {
            background-color: #ff4500;
            box-shadow: 0 0 10px #ff4500;
        }

        .btn-custom:focus {
            outline: none;
        }

        .btn-custom:disabled {
            cursor: not-allowed;
        }

        /* Media query for smaller screens (mobile) */
        @media (max-width: 899px) {
            #container {
                max-width: 100%;
            }
        }

        /* Media query for larger screens (desktop) */
        @media (min-width: 900px) {
            #container {
                max-width: 600px;
            }
        }

        @keyframes pulseStop {
            0% {
                box-shadow: 0 0 10px 0 rgba(255, 69, 0, 0.7);
            }

            50% {
                box-shadow: 0 0 20px 5px rgba(255, 69, 0, 0.7);
            }

            100% {
                box-shadow: 0 0 10px 0 rgba(255, 69, 0, 0.7);
            }
        }

        .btn-custom[data-action="stop"].pulse {
            box-shadow: 0 0 20px 5px rgba(255, 69, 0, .7);
        }

        .bpm-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-delete {
            background-color: #ff4500;
            color: white;
        }

        .btn-delete:hover {
            background-color: #B71C1C;
            color: white;
        }

        .btn-add {
            background-color: #008B8B;
            color: white;
        }

        .btn-add:hover {
            background-color: #005F5F;
            color: white;
        }

        .btn-control-custom:focus {
            outline: none;
            box-shadow: none
        }

        .bpm-control label,
        .bpm-control span {
            font-weight: bold;
            color: #4F4F4F;
        }

        body.dark-mode .bpm-control label,
        body.dark-mode .bpm-control span {
            color: white;
        }

        .bpm-control span {
            font-size: 1.2em;
        }

        .bpm-control input[type="range"] {
            flex: 1;
        }

        #iframeCifra {
            background-color: #fff;
            border-radius: 8px;
            transition: background-color 0.3s;
        }

        body.dark-mode #iframeCifra {
            background-color: #101524;
        }

        .list-group-item {
            background-color: #fff;
            border: 1px solid #ccc;
        }

        body.dark-mode .list-group-item {
            background-color: #101524;
            color: #fff;
            border: 1px solid #555;
        }

        /* #decreaseTom,
        #increaseTom {
            background-color: #9988B4;
            border-color: #9988B4;
        } */

        .top-control {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn-dark-cyan {
            background-color: #008B8B;
            color: #fff;
        }

        .btn-dark-cyan:hover {
            background-color: #005F5F;
            color: white;
        }

        .btn-dark-cyan:focus {
            outline: none;
            box-shadow: none
        }

        .switch {
            position: relative;
            top: 3px;
            left: 3px;
            right: -3px;
            bottom: -3px;
            /* top: 10px;
      right: 10px;
      display: inline-block; */
            width: 50px;
            height: 28px;
        }

        .switch input {
            display: none;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 5px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .slider:after {
            content: "\f186";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            font-size: 15px;
            color: #000;
        }

        input:checked+.slider:after {
            content: "\f185";
            right: 28px;
            color: #ffd700;
        }

        input:checked+.slider {
            background-color: #2196F3;
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }
    </style>
</head>

<body>
    <div class="container d-flex flex-column vh-100" id="container">
        <div class="top-control d-flex justify-content-center align-items-center mb-3 mt-3">
            <button class="btn btn-dark-cyan mx-2" id="decreaseTom"><i class="bi bi-dash"></i></button>
            <select class="form-control mx-2 w-auto" id="tomSelect"></select>
            <button class="btn btn-dark-cyan mx-2" id="increaseTom"><i class="bi bi-plus"></i></button>
        </div>

        <div class="mb-3 flex-grow-1">
            <iframe class="w-100 border border-secondary rounded" style="height: 100%;" id="iframeCifra"></iframe>
        </div>
        <div class="d-flex justify-content-center mb-3" id="controlButtons">
            <button class="btn btn-link" id="prevButton">
                <i class="bi bi-chevron-left"></i>
            </button>
            <button class="btn-custom mx-2" data-action="play" id="playButton"><i class="bi bi-play-fill"></i></button>
            <button class="btn-custom pressed pulse mx-2" data-action="stop" id="stopButton"><i
                    class="bi bi-search"></i></button>
            <button class="btn-custom mx-2" data-action="notes" id="notesButton"><i
                    class="bi bi-music-note-beamed"></i></button>
            <button class="btn btn-link" id="nextButton">
                <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- Modal para pesquisa -->
    <div class="modal fade" id="searchModal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <label class="switch mr-auto" for="darkModeToggle">
                        <input type="checkbox" id="darkModeToggle" />
                        <span class="slider"></span>
                    </label>
                    <h5 class="modal-title mx-auto" id="searchModalLabel">Cifras</h5>
                    <button type="button" class="close ml-auto" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <input class="form-control" placeholder="Pesquisar Música..." aria-label="Pesquisar" aria-describedby="basic-addon1" id="searchInput">
                        <button class="btn btn-primary rounded-right" type="button" id="searchButton">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            <i class="bi bi-search" id="searchIcon"></i>
                        </button>
                    </div>
                    <div class="d-flex align-items-center justify-content-between mt-3">  <!-- Container for select and button -->
                        <select class="form-control rounded-left" id="savesSelect">
                            <option value="all">Selecione uma Cifra...</option>
                        </select>
                        <button class="btn btn-control-custom btn-success rounded-0" id="editSavesSelect">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-danger rounded-right" id="deleteSavesSelect">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <textarea class="modal-textarea mt-3" id="editTextarea" placeholder="Criar nova Cifra..."></textarea>
                    <ul class="list-group mt-3 d-none" id="searchResults"></ul>
                    <ul class="list-group mt-3 d-none" id="saves"></ul>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="closeButton">× Fechar</button>
                    <div>
                        <button class="btn btn-control-custom btn-add" id="saveButton">
                            <i class="bi bi-save"></i> Salvar
                        </button>
                        <button type="button" class="btn btn-primary" id="startButton">
                            <i class="bi bi-check"></i> Tocar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="./assets/js/script.js"></script>
    <script src="./assets/js/Pizzicato.min.js"></script>
    <script src="./assets/js/audios.js"></script>
    <script>
        const elements = {
            controlButtons: document.getElementById('controlButtons'),
            editTextarea: document.getElementById('editTextarea'),
            startButton: document.getElementById('startButton'),
            saveButton: document.getElementById('saveButton'),
            playButton: document.getElementById('playButton'),
            notesButton: document.getElementById('notesButton'),
            stopButton: document.getElementById('stopButton'),
            searchButton: document.getElementById('searchButton'),
            searchInput: document.getElementById('searchInput'),
            spinner: document.querySelector('.spinner-border'),
            searchIcon: document.getElementById('searchIcon'),
            searchResultsList: document.getElementById('searchResults'),
            savesList: document.getElementById('saves'),
            pulseRange: document.getElementById('pulseRange'),
            bpmValue: document.getElementById('bpmValue'),
            iframeCifra: document.getElementById('iframeCifra'),
            prevButton: document.getElementById('prevButton'),
            nextButton: document.getElementById('nextButton'),
            darkModeToggle: document.getElementById('darkModeToggle'),
            searchModalLabel: document.getElementById('searchModalLabel'),
            savesSelect: document.getElementById('savesSelect'),
            editSavesSelect: document.getElementById('editSavesSelect'),
            deleteSavesSelect: document.getElementById('deleteSavesSelect'),
            tomSelect: document.getElementById('tomSelect')
        };

        const camposHarmonicos = {
            // Campos harmônicos maiores
            'C': ['C', 'Dm', 'Em', 'F', 'G', 'Am'],
            'Db': ['Db', 'Ebm', 'Fm', 'Gb', 'Ab', 'Bbm'],
            'C#': ['C#', 'D#m', 'Fm', 'F#', 'G#', 'A#m'],
            'D': ['D', 'Em', 'F#m', 'G', 'A', 'Bm'],
            'Eb': ['Eb', 'Fm', 'Gm', 'Ab', 'Bb', 'Cm'],
            'D#': ['D#', 'Fm', 'Gm', 'G#', 'A#', 'Cm'],
            'E': ['E', 'F#m', 'G#m', 'A', 'B', 'C#m'],
            'F': ['F', 'Gm', 'Am', 'Bb', 'C', 'Dm'],
            'F#': ['F#', 'G#m', 'A#m', 'B', 'C#', 'D#m'],
            'Gb': ['Gb', 'Abm', 'Bbm', 'B', 'Db', 'Ebm'],
            'G': ['G', 'Am', 'Bm', 'C', 'D', 'Em'],
            'G#': ['G#', 'A#m', 'B#m', 'C#', 'D#', 'Fm'],
            'Ab': ['Ab', 'Bbm', 'Cm', 'Db', 'Eb', 'Fm'],
            'A': ['A', 'Bm', 'C#m', 'D', 'E', 'F#m'],
            'A#': ['A#', 'B#m', 'Dm', 'D#', 'F', 'Gm'],
            'Bb': ['Bb', 'Cm', 'Dm', 'Eb', 'F', 'Gm'],
            'B': ['B', 'C#m', 'D#m', 'E', 'F#', 'G#m'],
            // Campos harmônicos menores
            'Am': ['Am', 'C', 'Dm', 'Em', 'F', 'G'],
            'Bbm': ['Bbm', 'Db', 'Ebm', 'Fm', 'Gb', 'Ab'],
            'B#m': ['B#m', 'D', 'E#m', 'F#m', 'G', 'A'],
            'Bm': ['Bm', 'D', 'Em', 'F#m', 'G', 'A'],
            'Cm': ['Cm', 'Eb', 'Fm', 'Gm', 'Ab', 'Bb'],
            'C#m': ['C#m', 'E', 'F#m', 'G#m', 'A', 'B'],
            'Dm': ['Dm', 'F', 'Gm', 'Am', 'Bb', 'C'],
            'D#m': ['D#m', 'Gb', 'Abm', 'Bbm', 'Cb', 'Db'],
            'Ebm': ['Ebm', 'Gb', 'Abm', 'Bbm', 'Cb', 'Db'],
            'Em': ['Em', 'G', 'Am', 'Bm', 'C', 'D'],
            'Fm': ['Fm', 'Ab', 'Bbm', 'Cm', 'Db', 'Eb'],
            'F#m': ['F#m', 'A', 'Bm', 'C#m', 'D', 'E'],
            'Gm': ['Gm', 'Bb', 'Cm', 'Dm', 'Eb', 'F'],
            'G#m': ['G#m', 'B', 'C#m', 'D#m', 'E', 'F#'],
            'Abm': ['Abm', 'Cb', 'Dbm', 'Ebm', 'Fb', 'Gb'],
            'A#m': ['A#m', 'D', 'E#m', 'F#m', 'G', 'A']
        };
        let acordeGroup = null;
        let parado = true;
        let indiceAcorde = 0;

        $('#searchModal').on('shown.bs.modal', exibirListaSaves);

        elements.savesSelect.addEventListener('change', () => {
            const selectItem = elements.savesSelect.value;
            const saves = JSON.parse(localStorage.getItem('saves'));
            elements.editTextarea.value = saves[selectItem];
        })

        elements.editSavesSelect.addEventListener('click', () => {
            const saveName = elements.savesSelect.value;
            if (saveName !== 'all') {
                editarSave(saveName);
                exibirListaSaves();
            }
        });

        elements.deleteSavesSelect.addEventListener('click', () => {
            const saveName = elements.savesSelect.value;
            if (saveName !== 'all') {
                if (confirm(`Deseja excluir ${saveName}?`)) {
                    deletarSave(saveName);
                    exibirListaSaves();
                }
            }
        });

        elements.searchButton.addEventListener('click', searchMusic);

        elements.notesButton.addEventListener('click', function () {
            if (indiceAcorde > 0) {
                indiceAcorde--;
            }

            if (!parado) {
                pararAcorde();
                avancarCifra();
            }
        });

        elements.stopButton.addEventListener('mousedown', function () {
            pararAcorde();
            const frameContent = elements.iframeCifra.contentDocument;
            const cifraElems = frameContent.getElementsByClassName('cifraSelecionada');

            Array.from(cifraElems).forEach(elemento => {
                elemento.classList.remove('cifraSelecionada');
            });

            if (indiceAcorde > 0) {
                indiceAcorde--;
            }
        });

        document.addEventListener('mousedown', fullScreen);

        elements.playButton.addEventListener('mousedown', function () {
            avancarCifra();
        });

        elements.saveButton.addEventListener('click', function () {
            const saveContent = elements.editTextarea.value;

            if (saveContent) {
                const saveName = prompt("Digite o nome para salvar:");

                if (saveName) {
                    salvarSaves(saveName, saveContent);
                }
            } else {
                elements.editTextarea.focus();
            }
        });

        elements.darkModeToggle.addEventListener('change', toggleDarkMode);

        elements.startButton.addEventListener('click', () => {
            if (elements.editTextarea.value) {
                const tom = descobrirTom(elements.editTextarea.value);
                mostrarTextoCifrasCarregado(tom, elements.editTextarea.value);
                const texto = elements.editTextarea.value;
                elements.iframeCifra.contentDocument.body.innerHTML = destacarCifras(texto);
                addEventCifrasIframe(elements.iframeCifra);
                $('#searchModal').modal('hide');
            }
            else {
                elements.searchInput.focus();
            }
        });

        elements.prevButton.addEventListener('click', () => {
            if (elements.controlButtons.classList.contains('justify-content-center')) {
                elements.controlButtons.classList.remove('justify-content-center');
                elements.controlButtons.classList.add('justify-content-left');
            }
            else if (elements.controlButtons.classList.contains('justify-content-end')) {
                elements.controlButtons.classList.remove('justify-content-end');
                elements.controlButtons.classList.add('justify-content-center');
            }
        });

        elements.nextButton.addEventListener('click', () => {
            if (elements.controlButtons.classList.contains('justify-content-center')) {
                elements.controlButtons.classList.remove('justify-content-center');
                elements.controlButtons.classList.add('justify-content-end');
            }
            else if (elements.controlButtons.classList.contains('justify-content-left')) {
                elements.controlButtons.classList.remove('justify-content-left');
                elements.controlButtons.classList.add('justify-content-center');
            }
        });

        function salvarSaves(saveName, saveContent) {
            let saves = localStorage.getItem('saves');
            if (saves) {
                saves = JSON.parse(saves);

                if (saves.hasOwnProperty(saveName)) {
                    alert("Já existe esse nome!");
                    return;
                }
            } else {
                saves = {};
            }

            saveContent = saveContent.replace(/<style[\s\S]*?<\/style>|<\/?[^>]+(>|$)/g, "");
            saves[saveName] = saveContent;
            localStorage.setItem('saves', JSON.stringify(saves));

            exibirListaSaves();
            elements.savesSelect.value = saveName;
        }

        function preencherSelect(tom) {
            elements.tomSelect.innerHTML = '';

            if (tonsMaiores.includes(tom)) {
                tonsMaiores.forEach(tom => {
                    const option = document.createElement('option');
                    option.value = tom;
                    option.text = tom;
                    elements.tomSelect.appendChild(option);
                });
            } else if (tonsMenores.includes(tom)) {
                tonsMenores.forEach(tom => {
                    const option = document.createElement('option');
                    option.value = tom;
                    option.text = tom;
                    elements.tomSelect.appendChild(option);
                });
            }

            elements.tomSelect.value = tom;
        }

        function descobrirTom(texto) {
            const somenteCifras = texto.match(/[A-G][#b]?m?/g);

            if (!somenteCifras) {
                return 'C';
            }

            const acordesOrdenados = [...somenteCifras].sort();

            const padroesAcordes = {
                doisMenores: false,
                doisMaiores: false
            };

            for (let i = 0; i < acordesOrdenados.length - 1; i++) {
                if (acordesOrdenados[i].endsWith('m') && acordesOrdenados[i + 1].endsWith('m')) {
                    padroesAcordes.doisMenores = true;
                }
                if (!acordesOrdenados[i].endsWith('m') && !acordesOrdenados[i + 1].endsWith('m')) {
                    padroesAcordes.doisMaiores = true;
                }
            }

            const possiveisTons = {};
            for (const [tom, acordes] of Object.entries(camposHarmonicos)) {
                let pontos = 0;

                if (padroesAcordes.doisMenores) {
                    for (let i = 0; i < acordes.length - 1; i++) {
                        if (acordes[i].endsWith('m') && acordes[i + 1].endsWith('m')) {
                            pontos += 1;
                        }
                    }
                }
                if (padroesAcordes.doisMaiores) {
                    for (let i = 0; i < acordes.length - 1; i++) {
                        if (!acordes[i].endsWith('m') && !acordes[i + 1].endsWith('m')) {
                            pontos += 1;
                        }
                    }
                }

                pontos += somenteCifras.filter(cifra => acordes.includes(cifra)).length;
                somenteCifras.forEach(cifra => {
                    if (!acordes.includes(cifra)) {
                        pontos -= 1; // Subtrai 1 ponto se o acorde não estiver no campo harmônico
                    }
                });

                possiveisTons[tom] = pontos;
            }

            const primeiroAcorde = somenteCifras[0];
            const ultimoAcorde = somenteCifras[somenteCifras.length - 1];

            for (const tom in possiveisTons) {
                if (camposHarmonicos[tom][0] === primeiroAcorde) {
                    possiveisTons[tom] += 1;
                }
                if (camposHarmonicos[tom][0] === ultimoAcorde) {
                    possiveisTons[tom] += 1;
                }
            }

            const tomProvavel = Object.keys(possiveisTons).reduce((a, b) => possiveisTons[a] > possiveisTons[b] ? a : b);
            return tomProvavel;
        }

        function descobrirTomOld(texto) {
            const somenteCifras = texto.match(/[A-G][#b]?m?/g);

            if (!somenteCifras) {
                return 'C';
            }

            const possiveisTons = {};
            for (const [tom, acordes] of Object.entries(camposHarmonicos)) {
                possiveisTons[tom] = somenteCifras.filter(cifra => acordes.includes(cifra)).length;
                somenteCifras.forEach(cifra => {
                    if (!acordes.includes(cifra)) {
                        possiveisTons[tom] -= 1;
                    }
                });
            }

            const primeiroAcorde = somenteCifras[0];
            const ultimoAcorde = somenteCifras[somenteCifras.length - 1];

            for (const tom in possiveisTons) {
                if (camposHarmonicos[tom][0] === primeiroAcorde) {
                    possiveisTons[tom] += 1;
                }
                if (camposHarmonicos[tom][0] === ultimoAcorde) {
                    possiveisTons[tom] += 1;
                }
            }
            
            const tomProvavel = Object.keys(possiveisTons).reduce((a, b) => possiveisTons[a] > possiveisTons[b] ? a : b);
            
            return tomProvavel;
        }

        function exibirListaSaves(botaoVoltarPressionado) {

            let saves = localStorage.getItem('saves');
            
            if (saves && saves !== '{}') {
                saves = JSON.parse(saves);

                for (const saveName in saves) {
                    const listItem = criarItemSelect(saveName, saves[saveName]);
                    elements.savesSelect.appendChild(listItem);
                }
            }
        }

        function criarItemSelect(saveName, saveContent) {
            const option = document.createElement('option');

            option.value = saveName;
            option.textContent = saveName;

            // Important: Check if the option already exists to avoid duplicates
            const existingOption = elements.savesSelect.querySelector(`option[value="${saveName}"]`);
            if (!existingOption) {
                elements.savesSelect.appendChild(option);
            }

            // Optionally, add an event listener for the select option
            option.addEventListener('click', () => {
                //Handle what happens when the option is selected
                //You would likely want to load the saveContent into editTextarea
                //Example, but adjust this to your needs.
                elements.editTextarea.value = saveContent;
                elements.searchModalLabel.textContent = saveName; //Update modal label
            });

            return option;
        }

        function criarItemLista(saveName, saveContent) {
            elements.savesList.innerHTML = '';
            const listItem = document.createElement('li');
            listItem.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');

            listItem.textContent = saveName;

            const deleteButton = document.createElement('button');
            deleteButton.classList.add('btn', 'btn-danger', 'btn-sm');
            deleteButton.innerHTML = '<i class="bi bi-trash"></i>';

            deleteButton.addEventListener('click', () => {
                if (confirm(`Deseja excluir ${saveName}?`)) {
                    deletarSave(saveName);
                    exibirListaSaves();
                }
            });

            listItem.appendChild(deleteButton);

            listItem.addEventListener('click', () => {
                desselecionarTodos();
                listItem.classList.add('selected');
                elements.editTextarea.value = saveContent;
                elements.searchModalLabel.textContent = saveName;
                elements.editTextarea.classList.remove('d-none');
                elements.savesList.classList.add('d-none');
                elements.saveButton.classList.remove('d-none');
                elements.startButton.classList.remove('d-none');
            });
            return listItem;
        }

        function desselecionarTodos() {
            const allItems = document.querySelectorAll('.list-group-item');
            allItems.forEach(item => item.classList.remove('selected'));
        }

        function editarSave(saveName) {
            let optionToEdit = savesSelect.querySelector(`option[value="${saveName}"]`);

            if (optionToEdit) {
                let saves = JSON.parse(localStorage.getItem('saves')) || {};
                const newSaveName = prompt("Digite o novo nome para o save:");

                if (newSaveName) {
                    if (saves.hasOwnProperty(newSaveName)) {
                        alert("Já existe esse nome!");
                        return;
                    }

                    const saveContent = saves[saveName];
                    saves[newSaveName] = saveContent;
                    delete saves[saveName];
                    localStorage.setItem('saves', JSON.stringify(saves));

                    optionToEdit.textContent = newSaveName;
                    optionToEdit.value = newSaveName;
                }
            }
        }

        function deletarSave(saveName) {
            let saves = JSON.parse(localStorage.getItem('saves') || '{}');
            delete saves[saveName];
            localStorage.setItem('saves', JSON.stringify(saves));
        }

        async function searchMusic() {
            elements.editTextarea.classList.add('d-none');
            elements.searchIcon.classList.add('d-none');
            elements.spinner.classList.remove('d-none');
            elements.savesList.classList.add('d-none');
            elements.saveButton.classList.add('d-none');
            elements.startButton.classList.add('d-none');
            elements.searchResultsList.classList.remove('d-none');
            elements.searchResultsList.innerHTML = '';
            elements.searchButton.disabled = true;

            const textoPesquisa = elements.searchInput.value;

            try {
                const response = await fetch('https://apinode-h4wt.onrender.com/pesquisar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ texto: textoPesquisa }),
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.success) {
                    const { lista: titles, links } = data; // destructuring
                    if (titles.length > 0) {
                        titles.forEach((title, index) => {
                            const listItem = document.createElement('li');
                            listItem.className = 'list-group-item';
                            const link = document.createElement('a');
                            link.href = '#';
                            link.onclick = () => choseLink(links[index], title);
                            link.textContent = title;
                            listItem.appendChild(link);
                            elements.searchResultsList.appendChild(listItem);
                        });
                    } else {
                        elements.searchResultsList.innerHTML = '<li class="list-group-item">Nenhuma cifra encontrada.</li>';
                    }
                } else { throw new Error(data.message); }
            } catch (error) {
                alert(`Erro na busca: ${error.message}`);
                elements.savesList.classList.remove('d-none');
                elements.searchResultsList.classList.add('d-none');
            } finally {
                elements.searchButton.disabled = false;
                elements.spinner.classList.add('d-none');
                elements.searchIcon.classList.remove('d-none');
            }
        }

        async function choseLink(urlLink, text) {
            elements.searchButton.disabled = true;
            elements.spinner.classList.remove('d-none');
            elements.searchIcon.classList.add('d-none');
            elements.searchResultsList.innerHTML = '';

            try {
                const response = await fetch('https://apinode-h4wt.onrender.com/downloadsite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: urlLink }),
                });
                const data = await response.json();
                if (data.success) {
                    mostrarTextoCifrasCarregado(data.tom, data.message);                    
                    elements.searchModalLabel.textContent = text;
                    elements.editTextarea.classList.remove('d-none');
                    elements.startButton.classList.remove('d-none');
                    elements.saveButton.classList.remove('d-none');
                } else {
                    alert(data.message);
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Erro ao baixar a cifra. Tente novamente mais tarde.');
            } finally {
                elements.searchButton.disabled = false;
                elements.spinner.classList.add('d-none');
                elements.searchIcon.classList.remove('d-none');
                elements.searchResultsList.classList.add('d-none');
            }
        }

        const togglePressedState = (event) => {
            const button = event.currentTarget;
            const action = button.dataset.action;

            if (action === 'notes') {
                if (elements.notesButton.classList.contains('pressed')) {
                    elements.notesButton.classList.remove('pressed');
                } else {
                    elements.notesButton.classList.add('pressed');
                }
            } else {
                button.classList.remove('pressed');
                setTimeout(() => button.classList.add('pressed'), 100);

                if (action === 'play') {
                    setTimeout(() => button.classList.add('pulse'), 100);
                    elements.stopButton.classList.remove('pulse');
                    elements.stopButton.innerHTML = '<i class="bi bi-stop-fill"></i>';
                    elements.playButton.classList.remove('pulse');
                } else {
                    if (action === 'stop' && elements.stopButton.innerHTML.includes('bi-search')) {
                        $('#searchModal').modal('show');
                    }
                    elements.playButton.classList.remove('pressed', 'pulse');
                    elements.stopButton.classList.add('pulse');
                    elements.stopButton.innerHTML = '<i class="bi bi-search"></i>';
                }
            }
        };

        const mudarTempoCompasso = (bpm) => {
            const tempo = parseInt(bpm.value);
            const bpmValor = 60000 / tempo;
            elements.bpmValue.textContent = tempo;
            elements.playButton.style.animationDuration = `${bpmValor}ms`;
            elements.stopButton.style.animationDuration = `${bpmValor}ms`;
        };

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
            aplicarModoEscuroIframe();
        };

        const updateSwitchDarkMode = () => {
            const isDarkMode = document.body.classList.contains('dark-mode');
            if (isDarkMode) {
                elements.darkModeToggle.checked = true;
            } else {
                elements.darkModeToggle.checked = false;
            }
        };

        const aplicarModoEscuroIframe = () => {
            const iframeDoc = elements.iframeCifra.contentDocument || elements.iframeCifra.contentWindow.document;
            iframeDoc.body.style.color = document.body.classList.contains('dark-mode') ? '#FFFFFF' : '#4F4F4F';
        };

        document.addEventListener('DOMContentLoaded', function () {
        });

        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            updateSwitchDarkMode();
            aplicarModoEscuroIframe();
        }

        function mostrarTextoCifrasCarregado(tom = null, texto = null) {
            if (tom) {
                preencherSelect(tom);
            }

            if (texto) {
                const textoSemTags = texto.replace(/<style[\s\S]*?<\/style>|<\/?[^>]+(>|$)/g, "");
                elements.editTextarea.value = textoSemTags;
            }
        }

        function addEventCifrasIframe(frame) {
            var elements = frame.contentDocument.getElementsByTagName("b");

            for (var i = 0; i < elements.length; i++) {
                elements[i].addEventListener("click", function (e) {
                    var cifraElements = frame.contentDocument.getElementsByClassName('cifraSelecionada');

                    if (cifraElements.length > 0)
                        cifraElements[0].classList.remove('cifraSelecionada');

                    e.target.classList.add('cifraSelecionada');
                    e.target.scrollIntoView();
                    parent.tocarCifraManualmente(e.target);

                    parent.focus(); //Foca fora para funcionar o teclado físico
                });
            }
        }

        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function fullScreen() {
            if (isMobileDevice()) {
                if (!document.fullscreenElement &&    // Opera 12.1, Firefox, Chrome, Edge, Safari
                    !document.webkitFullscreenElement && // Old WebKit
                    !document.mozFullScreenElement && // Old Firefox
                    !document.msFullscreenElement) {  // IE/Edge
                    var el = document.documentElement;
                    var requestMethod = el.requestFullscreen || el.webkitRequestFullscreen ||
                        el.mozRequestFullScreen || el.msRequestFullscreen;

                    if (requestMethod) {
                        requestMethod.call(el);
                    }

                    let wakeLock = null;
                    try {
                        wakeLock = navigator.wakeLock.request("screen");
                    } catch { }
                }
            }
        }

        function destacarCifras(texto) {
            const linhas = texto.split('\n');
            let cifraNum = 1;
            const linhasDestacadas = linhas.map(linha => {
                if (!/[a-zA-Z]{3,}/.test(linha)) {
                    const palavras = linha.split(/\s+/);
                    const espacos = linha.match(/\s+/g) || [];
                    const linhaProcessada = palavras.map((palavra, index) => {
                        let acorde = palavra;
                        while (!notasAcordes.includes(acorde) && acorde) {
                            acorde = acorde.slice(0, -1);
                        }
                        const elemento = notasAcordes.includes(acorde) ? `<b id="cifra${cifraNum++}">${acorde}</b>` : palavra;
                        return index < palavras.length - 1 && espacos[index] ? elemento + espacos[index] : elemento;
                    }).join('');
                    return linhaProcessada;
                }
                return linha;
            });
            return (`<style>.cifraSelecionada{background-color:#DAA520}</style><pre>${linhasDestacadas.join('\n')}</pre>`);
        }

        function tocarAcorde(acorde) {
            pararAcorde();

            if (!acordeGroup) {
                acordeGroup = new Pizzicato.Group();
                acordeGroup.attack = 0.1;
            }

            const notas = notasAcordesJson[acorde];

            acordeGroup.addSound(acordes[`orgao_${notas[0]}_grave`]);
            acordeGroup.addSound(acordes[`strings_${notas[0]}_grave`]);

            notas.forEach(nota => {
                acordeGroup.addSound(acordes[`orgao_${nota}_baixo`]);
                acordeGroup.addSound(acordes[`strings_${nota}_baixo`]);

                if (elements.notesButton.classList.contains('pressed')) {
                    acordeGroup.addSound(acordes[`orgao_${nota}`]);
                    acordeGroup.addSound(acordes[`strings_${nota}`]);
                }
            });

            parado = false;
            acordeGroup.play();
        }

        function pararAcorde() {
            if (acordeGroup) {
                acordeGroup.stop();
                parado = true;

                var sons = acordeGroup.sounds.length;
                for (let i = sons - 1; i > -1; i--) {
                    acordeGroup.removeSound(acordeGroup.sounds[i]);
                };
            }
        }

        function removerClasseCifraSelecionada(iframeDoc, excecao = null) {
            const elementos = iframeDoc.querySelectorAll('.cifraSelecionada');
            elementos.forEach(elemento => {
                if (elemento !== excecao) {
                    elemento.classList.remove('cifraSelecionada');
                }
            });
        }

        function avancarCifra() {
            const frameContent = elements.iframeCifra.contentDocument;
            const elements_b = frameContent.getElementsByTagName('b');
            const cifraElems = frameContent.getElementsByClassName('cifraSelecionada');
            parado = false;

            if (indiceAcorde < elements_b.length) {
                if (cifraElems.length > 0)
                    cifraElems[0].classList.remove('cifraSelecionada');

                const cifraElem = elements_b[indiceAcorde];
                if (cifraElem) {
                    const cifra = cifraElem.innerHTML.trim();
                    tocarAcorde(cifra);

                    cifraElem.classList.add('cifraSelecionada');
                    cifraElem.scrollIntoView();

                    indiceAcorde++;
                }
            }
        }

        function tocarCifraManualmente(cifraElem) {
            indiceAcorde = cifraElem.id.split('cifra')[1] - 1;

            if (parado === false) {
                elements.playButton.dispatchEvent(new Event('mousedown'));
            }
        }

        ['mousedown'].forEach(event => {
            elements.playButton.addEventListener(event, togglePressedState);
            elements.notesButton.addEventListener(event, togglePressedState);
            elements.stopButton.addEventListener(event, togglePressedState);
        });
    </script>
</body>

</html>