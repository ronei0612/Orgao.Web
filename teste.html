<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Botões de Play e Stop</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .modal-textarea {
            width: 100%;
            height: 300px;
            resize: vertical;
            padding: 10px;
        }

        body {
            background-color: #F0F0F0;
            transition: background-color 0.3s;
        }

        body.dark-mode {
            background-color: #0C101C;
            color: #fff;
        }

        /* .dark-mode, */
        .modal-content {
            transition: background-color 0.3s, color 0.3s;
        }

        .modal-content {
            background-color: #F0F0F0;
            color: #333;
        }

        body.dark-mode .modal-content {
            background-color: #1D2439;
            color: white;
        }

        #toggleDarkMode {
            display: flex;
            align-items: center;
        }

        #toggleDarkMode i {
            margin-right: 8px;
        }

        .btn-custom {
            border-radius: 50%;
            color: white;
            width: 55px;
            height: 55px;
            font-size: 24px;
            border: none;
            transition: background-color .3s, box-shadow .3s;
            outline: 0;
            user-select: none;
            margin: 8px;
        }

        .btn-custom[data-action="play"] {
            background-color: #9988B4;
        }

        .btn-custom[data-action="play"].pressed {
            background-color: #8A2BE2;
            box-shadow: 0 0 10px #8A2BE2;
        }

        .btn-custom[data-action="play"].pulse {
            box-shadow: 0 0 20px 5px rgba(138, 43, 226, .7);
        }

        .btn-custom[data-action="notes"] {
            background-color: #9988B4;
        }

        .btn-custom[data-action="notes"].pressed {
            background-color: #8A2BE2;
            box-shadow: 0 0 10px #8A2BE2;
        }

        .btn-custom[data-action="stop"] {
            background-color: tomato;
        }

        .btn-custom[data-action="stop"].pressed {
            background-color: #ff4500;
            box-shadow: 0 0 10px #ff4500;
        }

        .btn-custom:focus {
            outline: none;
        }

        .btn-custom:disabled {
            cursor: not-allowed;
        }

        /* Media query for smaller screens (mobile) */
        @media (max-width: 899px) {
            #container {
                max-width: 100%;
            }
        }

        /* Media query for larger screens (desktop) */
        @media (min-width: 900px) {
            #container {
                max-width: 600px;
            }
        }

        @keyframes pulseStop {
            0% {
                box-shadow: 0 0 10px 0 rgba(255, 69, 0, 0.7);
            }

            50% {
                box-shadow: 0 0 20px 5px rgba(255, 69, 0, 0.7);
            }

            100% {
                box-shadow: 0 0 10px 0 rgba(255, 69, 0, 0.7);
            }
        }

        .btn-custom[data-action="stop"].pulse {
            box-shadow: 0 0 20px 5px rgba(255, 69, 0, .7);
        }

        .bpm-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .bpm-control label,
        .bpm-control span {
            font-weight: bold;
            color: #4F4F4F;
        }

        body.dark-mode .bpm-control label,
        body.dark-mode .bpm-control span {
            color: white;
        }

        .bpm-control span {
            font-size: 1.2em;
        }

        .bpm-control input[type="range"] {
            flex: 1;
        }

        #iframeCifra {
            background-color: #fff;
            border-radius: 8px;
            transition: background-color 0.3s;
        }

        body.dark-mode #iframeCifra {
            background-color: #101524;
        }

        .list-group-item {
            background-color: #fff;
            border: 1px solid #ccc;
        }

        body.dark-mode .list-group-item {
            background-color: #101524;
            color: #fff;
            border: 1px solid #555;
        }

        /* #decreaseTom,
        #increaseTom {
            background-color: #9988B4;
            border-color: #9988B4;
        } */

        .top-control {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn-dark-cyan {
            background-color: #008B8B;
            color: #fff;
        }
    </style>
</head>

<body>
    <div class="container d-flex flex-column vh-100" id="container">
        <div class="top-control d-flex justify-content-center align-items-center mb-3 mt-3">
            <button class="btn btn-dark-cyan mx-2" id="decreaseTom"><i class="bi bi-dash"></i></button>
            <select class="form-control mx-2 w-auto" id="tomSelect"></select>
            <button class="btn btn-dark-cyan mx-2" id="increaseTom"><i class="bi bi-plus"></i></button>
        </div>

        <div class="mb-3 flex-grow-1">
            <iframe class="w-100 border border-secondary rounded" style="height: 100%;" id="iframeCifra"></iframe>
        </div>
        <div class="d-flex justify-content-center mb-3" id="controlButtons">
            <button class="btn btn-link" id="prevButton">
                <i class="bi bi-chevron-left"></i>
            </button>
            <button class="btn-custom mx-2" data-action="play" id="playButton"><i class="bi bi-play-fill"></i></button>
            <button class="btn-custom pressed pulse mx-2" data-action="stop" id="stopButton"><i
                    class="bi bi-search"></i></button>
            <button class="btn-custom mx-2" data-action="notes" id="notesButton"><i
                    class="bi bi-music-note-beamed"></i></button>
            <button class="btn btn-link" id="nextButton">
                <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- Modal para pesquisa -->
    <div class="modal fade" id="searchModal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="searchModalLabel">Cifras</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <input class="form-control" placeholder="Pesquisar Música..." aria-label="Pesquisar"
                            aria-describedby="basic-addon1" id="searchInput">
                        <button class="btn btn-primary" type="button" id="searchButton">
                            <span class="spinner-border spinner-border-sm d-none" role="status"
                                aria-hidden="true"></span>
                            <i class="bi bi-search" id="searchIcon"></i>
                        </button>
                        <textarea class="modal-textarea mt-3" id="editTextarea"></textarea>
                    </div>
                    <ul class="list-group mt-3" id="searchResults"></ul>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-dark" id="toggleDarkMode">
                        <i class="bi bi-moon-fill"></i> Modo Escuro
                    </button>
                    <div>
                        <button type="button" class="btn btn-primary" id="saveButton">Iniciar</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="./assets/js/script.js"></script>
    <script src="./assets/js/Pizzicato.min.js"></script>
    <script src="./assets/js/audios.js"></script>
    <script>
        const elements = {
            controlButtons: document.getElementById('controlButtons'),
            editTextarea: document.getElementById('editTextarea'),
            saveButton: document.getElementById('saveButton'),
            playButton: document.getElementById('playButton'),
            notesButton: document.getElementById('notesButton'),
            stopButton: document.getElementById('stopButton'),
            searchButton: document.getElementById('searchButton'),
            searchInput: document.getElementById('searchInput'),
            spinner: document.querySelector('.spinner-border'),
            searchIcon: document.getElementById('searchIcon'),
            searchResultsList: document.getElementById('searchResults'),
            pulseRange: document.getElementById('pulseRange'),
            bpmValue: document.getElementById('bpmValue'),
            toggleDarkModeButton: document.getElementById('toggleDarkMode'),
            iframeCifra: document.getElementById('iframeCifra'),
            prevButton: document.getElementById('prevButton'),
            nextButton: document.getElementById('nextButton')
        };

        elements.saveButton.addEventListener('click', () => {
            mostrarTextoCifrasCarregado(null, elements.editTextarea.value);
            const texto = elements.editTextarea.value;
            elements.iframeCifra.contentDocument.body.innerHTML = destacarCifras(texto);
            addEventCifrasIframe(elements.iframeCifra);
            $('#searchModal').modal('hide');
        });

        elements.prevButton.addEventListener('click', () => {
            if (elements.controlButtons.classList.contains('justify-content-center')) {
                elements.controlButtons.classList.remove('justify-content-center');
                elements.controlButtons.classList.add('justify-content-left');
            }
            else if (elements.controlButtons.classList.contains('justify-content-end')) {
                elements.controlButtons.classList.remove('justify-content-end');
                elements.controlButtons.classList.add('justify-content-center');
            }
        });

        elements.nextButton.addEventListener('click', () => {
            if (elements.controlButtons.classList.contains('justify-content-center')) {
                elements.controlButtons.classList.remove('justify-content-center');
                elements.controlButtons.classList.add('justify-content-end');
            }
            else if (elements.controlButtons.classList.contains('justify-content-left')) {
                elements.controlButtons.classList.remove('justify-content-left');
                elements.controlButtons.classList.add('justify-content-center');
            }
        });

        async function searchMusic() {
            elements.editTextarea.classList.add('d-none');
            elements.searchIcon.classList.add('d-none');
            elements.spinner.classList.remove('d-none');
            elements.searchButton.disabled = true;
            elements.searchResultsList.innerHTML = '';

            const textoPesquisa = elements.searchInput.value;

            try {
                const response = await fetch('https://apinode-h4wt.onrender.com/pesquisar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ texto: textoPesquisa }),
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.success) {
                    const { lista: titles, links } = data; // destructuring
                    if (titles.length > 0) {
                        titles.forEach((title, index) => {
                            const listItem = document.createElement('li');
                            listItem.className = 'list-group-item';
                            const link = document.createElement('a');
                            link.href = '#';
                            link.onclick = () => choseLink(links[index]);
                            link.textContent = title;
                            listItem.appendChild(link);
                            elements.searchResultsList.appendChild(listItem);
                        });
                    } else {
                        elements.searchResultsList.innerHTML = '<li class="list-group-item">Nenhuma cifra encontrada.</li>';
                    }
                } else { throw new Error(data.message); }
            } catch (error) {
                console.error('Erro na busca:', error);
                alert(`Erro na busca: ${error.message}`);
            } finally {
                elements.searchButton.disabled = false;
                elements.spinner.classList.add('d-none');
                elements.searchIcon.classList.remove('d-none');
            }
        }

        async function choseLink(urlLink) {
            elements.searchButton.disabled = true;
            elements.spinner.classList.remove('d-none');
            elements.searchIcon.classList.add('d-none');
            elements.searchResultsList.innerHTML = '';

            try {
                const response = await fetch('https://apinode-h4wt.onrender.com/downloadsite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: urlLink }),
                });
                const data = await response.json();
                if (data.success) {
                    mostrarTextoCifrasCarregado(data.tom, data.message);
                    elements.editTextarea.classList.remove('d-none');
                } else {
                    alert(data.message);
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Erro ao baixar a cifra. Tente novamente mais tarde.');
            } finally {
                elements.searchButton.disabled = false;
                elements.spinner.classList.add('d-none');
                elements.searchIcon.classList.remove('d-none');
            }
        }

        const togglePressedState = (event) => {
            const button = event.currentTarget;
            const action = button.dataset.action;

            if (action === 'notes') {
                if (elements.notesButton.classList.contains('pressed')) {
                    elements.notesButton.classList.remove('pressed');
                } else {
                    elements.notesButton.classList.add('pressed');
                }
            } else {
                button.classList.remove('pressed');
                setTimeout(() => button.classList.add('pressed'), 100);

                if (action === 'play') {
                    setTimeout(() => button.classList.add('pulse'), 100);
                    elements.stopButton.classList.remove('pulse');
                    elements.stopButton.innerHTML = '<i class="bi bi-stop-fill"></i>';
                    elements.playButton.classList.remove('pulse');
                } else {
                    if (action === 'stop' && elements.stopButton.innerHTML.includes('bi-search')) {
                        $('#searchModal').modal('show');
                    }
                    elements.playButton.classList.remove('pressed', 'pulse');
                    elements.stopButton.classList.add('pulse');
                    elements.stopButton.innerHTML = '<i class="bi bi-search"></i>';
                }
            }
        };

        const mudarTempoCompasso = (bpm) => {
            const tempo = parseInt(bpm.value);
            const bpmValor = 60000 / tempo;
            elements.bpmValue.textContent = tempo;
            elements.playButton.style.animationDuration = `${bpmValor}ms`;
            elements.stopButton.style.animationDuration = `${bpmValor}ms`;
        };

        const toggleDarkMode = () => {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
            updateDarkModeText();
            aplicarModoEscuroIframe();
        };

        const updateDarkModeText = () => {
            elements.toggleDarkModeButton.innerHTML = document.body.classList.contains('dark-mode') ? '<i class="bi bi-brightness-high-fill"></i> Modo Claro' : '<i class="bi bi-moon-fill"></i> Modo Escuro';
        };

        const aplicarModoEscuroIframe = () => {
            const iframeDoc = elements.iframeCifra.contentDocument || elements.iframeCifra.contentWindow.document;
            iframeDoc.body.style.color = document.body.classList.contains('dark-mode') ? '#FFFFFF' : '#4F4F4F';
        };

        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            updateDarkModeText();
            aplicarModoEscuroIframe();
        }

        ['mousedown'].forEach(event => {
            elements.playButton.addEventListener(event, togglePressedState);
            elements.notesButton.addEventListener(event, togglePressedState);
            elements.stopButton.addEventListener(event, togglePressedState);
        });
        elements.toggleDarkModeButton.addEventListener('click', toggleDarkMode);
        elements.searchButton.addEventListener('click', searchMusic);

        function mostrarTextoCifrasCarregado(tom = null, texto = null) {
            if (tom) {
                tom = getAcorde(tom)[0];
                if (tom.includes('m'))
                    adicionarTonsSelect('tomSelect', tonsMenores.indexOf(tom), false);
                else
                    adicionarTonsSelect('tomSelect', tonsMaiores.indexOf(tom), true);
            }

            if (texto) {
                const textoSemTags = texto.replace(/<\/?[^>]+(>|$)/g, "");
                elements.editTextarea.value = textoSemTags;
            }
        }

        function addEventCifrasIframe(frame) {
            var elements = frame.contentDocument.getElementsByTagName("b");

            for (var i = 0; i < elements.length; i++) {
                elements[i].addEventListener("click", function (e) {
                    var cifraElements = frame.contentDocument.getElementsByClassName('cifraSelecionada');

                    if (cifraElements.length > 0)
                        cifraElements[0].classList.remove('cifraSelecionada');

                    e.target.classList.add('cifraSelecionada');
                    e.target.scrollIntoView();
                    parent.tocarCifraManualmente(e.target);

                    parent.focus(); //Foca fora para funcionar o teclado físico
                });
            }
        }

        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function fullScreen() {
            if (isMobileDevice()) {
                if (!document.fullscreenElement &&    // Opera 12.1, Firefox, Chrome, Edge, Safari
                    !document.webkitFullscreenElement && // Old WebKit
                    !document.mozFullScreenElement && // Old Firefox
                    !document.msFullscreenElement) {  // IE/Edge
                    var el = document.documentElement;
                    var requestMethod = el.requestFullscreen || el.webkitRequestFullscreen ||
                        el.mozRequestFullScreen || el.msRequestFullscreen;

                    if (requestMethod) {
                        requestMethod.call(el);
                    }

                    let wakeLock = null;
                    try {
                        wakeLock = navigator.wakeLock.request("screen");
                    } catch { }
                }
            }
        }

        document.addEventListener('mousedown', fullScreen);

        function adicionarTonsSelect(element, index, maior) {
            var selectElem = document.getElementById(element);
            selectElem.innerHTML = "";

            var tons = tonsMaiores;
            if (maior === false)
                tons = tonsMenores;

            for (var i = 0; i < tons.length; i++) {
                let opt = document.createElement('option');
                opt.value = tons[i];
                opt.textContent += tons[i];
                selectElem.appendChild(opt);
            };

            selectElem.selectedIndex = index;
            //textoAcordeMenor.innerText = tonsMenores[index];
        }

        function destacarCifras(texto) {
            const linhas = texto.split('\n');
            let cifraNum = 1;
            const linhasDestacadas = linhas.map(linha => {
                if (!/[a-zA-Z]{3,}/.test(linha)) {
                    const palavras = linha.split(/\s+/);
                    const espacos = linha.match(/\s+/g) || [];
                    const linhaProcessada = palavras.map((palavra, index) => {
                        let acorde = palavra;
                        while (!notasAcordes.includes(acorde) && acorde) {
                            acorde = acorde.slice(0, -1);
                        }
                        const elemento = notasAcordes.includes(acorde) ? `<b id="cifra${cifraNum++}">${acorde}</b>` : palavra;
                        return index < palavras.length - 1 && espacos[index] ? elemento + espacos[index] : elemento;
                    }).join('');
                    return linhaProcessada;
                }
                return linha;
            });
            return (`<style>.cifraSelecionada{background-color:#DAA520}</style><pre>${linhasDestacadas.join('\n')}</pre>`);
        }

        let acordeGroup = null;

        function tocarAcorde(acorde) {
            pararAcorde();

            if (!acordeGroup) {
                acordeGroup = new Pizzicato.Group();
                acordeGroup.attack = 0.1;
            }

            const notas = notasAcordesJson[acorde];

            acordeGroup.addSound(acordes[`orgao_${notas[0]}_grave`]);
            acordeGroup.addSound(acordes[`strings_${notas[0]}_grave`]);

            notas.forEach(nota => {
                acordeGroup.addSound(acordes[`orgao_${nota}_baixo`]);
                acordeGroup.addSound(acordes[`strings_${nota}_baixo`]);

                if (elements.notesButton.classList.contains('pressed')) {
                    acordeGroup.addSound(acordes[`orgao_${nota}`]);
                    acordeGroup.addSound(acordes[`strings_${nota}`]);
                }
            });

            parado = false;
            acordeGroup.play();
        }

        function pararAcorde() {
            if (acordeGroup) {
                acordeGroup.stop();
                parado = true;

                var sons = acordeGroup.sounds.length;
                for (let i = sons - 1; i > -1; i--) {
                    acordeGroup.removeSound(acordeGroup.sounds[i]);
                };
            }
        }

        let parado = true;
        let indiceAcorde = 0;

        elements.playButton.addEventListener('mousedown', function () {
            avancarCifra();
        });

        function removerClasseCifraSelecionada(iframeDoc, excecao = null) {
            const elementos = iframeDoc.querySelectorAll('.cifraSelecionada');
            elementos.forEach(elemento => {
                if (elemento !== excecao) {
                    elemento.classList.remove('cifraSelecionada');
                }
            });
        }

        elements.notesButton.addEventListener('mousedown', function () {
            if (indiceAcorde > 0) {
                indiceAcorde--;
            }

            if (!parado) {
                pararAcorde();
                avancarCifra();
            }
        });

        elements.stopButton.addEventListener('mousedown', function () {
            pararAcorde();
            const frameContent = elements.iframeCifra.contentDocument;
            const cifraElems = frameContent.getElementsByClassName('cifraSelecionada');

            Array.from(cifraElems).forEach(elemento => {
                elemento.classList.remove('cifraSelecionada');
            });

            if (indiceAcorde > 0) {
                //tocando = false;
                indiceAcorde--;
            }
        });

        function avancarCifra() {
            const frameContent = elements.iframeCifra.contentDocument;
            const elements_b = frameContent.getElementsByTagName('b');
            const cifraElems = frameContent.getElementsByClassName('cifraSelecionada');
            parado = false;

            if (indiceAcorde < elements_b.length) {
                if (cifraElems.length > 0)
                    cifraElems[0].classList.remove('cifraSelecionada');

                const cifraElem = elements_b[indiceAcorde];
                if (cifraElem) {
                    const cifra = cifraElem.innerHTML.trim();
                    tocarAcorde(cifra);

                    cifraElem.classList.add('cifraSelecionada');
                    cifraElem.scrollIntoView();

                    indiceAcorde++;
                }
            }
        }

        function tocarCifraManualmente(cifraElem) {
            indiceAcorde = cifraElem.id.split('cifra')[1] - 1;

            if (parado === false) {
                elements.playButton.dispatchEvent(new Event('mousedown'));
            }
        }
    </script>
</body>

</html>